# 线索登记组件集成对应修改梳理

>author: 孙文浩

>date: 2019.12.24.

---

## 目录
- [对接概述](#对接概述)
- [概要设计](#概要设计)
    - 对接模块
    - 修改范围梳理
    - 功能模块划分、开发任务梳理
- [模块详细设计](#模块详细设计)
    - 字段映射共用方法
    - 附件
---

## 对接概述
1. 使用组件html、controller、service
2. dao层业务系统自定义，组件页面字段与后台字段做映射转换
3. 库表结构修改，缺字段加字段
4. 组件集成在zjjdApi中，执纪监督嵌页面方式
---

## 概要设计
1. 对接模块
- 基本信息
- 被反映人/被举报人
- 反映人/举报人
- 问题线索摘要
- 违纪违法
- 附件

2. 修改范围梳理
- 公共修改

        1.表结构修改，增加缺少字段
        2.组件页面字段与后台表字段，映射转换
        3.模块嵌入页面，相关列表展示适配修改
        4.相关流程代码适配调整（线索流转）
        5.相关接口适配修改（如调查措施等）
        6.单值代码梳理，更改或做映射处理，尽可能使用统一后的单值代码，尽可能兼容原系统单值代码，影响范围大的单值代码可暂时不做修改
        7.附件，表结构设计适配新附件
        8.问责模块联动

- 谈话函询

        1.被举报人/被反映人：
            模块替换
        2.谈话：
            附件上传
        3.谈话办理节结束：
            表格沿用
            谈话函询结论，编辑弹框，使用组件页面
            问责模块展示控制调整
            问责建议编辑弹框可复用登记组件
            附件


- 初步核实
        
        1.被举报人/被反映人：
            模块替换
        2.初核方案：
            附件上传
        3.初核报告：
           问责对象信息的维护替换（添加/编辑，单位/个人）
           附件上传
           初核结论违纪违法
           问责模块展示控制调整
        4.结束初核的校验（违纪违法、个人/单位 信息必填项）




- 立案审查调查
        
        1.立案信息
            上传附件
        2.被调查人情况
            信息登记模块替换
        3.审查调查方案
            上传附件
        4.延长审查调查时限
            上传附件
        5.审查调查情况
            上传相关材料
            审查调查情况违纪违法信息编辑
            问责对象信息维护替换
        6.移送审理
            上传附件



- 案件审理

        案件审理办理（A6前后端分离）：
            1.延长审理时限：
                附件
            2.检查机关提前介入：
                附件
            3.审理结论：
                附件
                问责对象编辑弹框可复用登记组件
                适配违纪违法行为
            4.移送司法：
                附件
            5.结案登记：
                附件


3. 功能模块划分、开发任务梳理

        1.被反映人/被举报人模块，嵌页面、后台逻辑处理
            涉及业务模块：谈话函询、初步核实、立案审查调查
        2.结论模块，违纪违法行为弹框,嵌页面、后台逻辑处理
            涉及业务模块：谈话函询、初步核实、立案审查调查、案件审理办理
        3.附件模块，表结构设计，嵌页面、后台逻辑处理
            涉及业务模块：谈话函询、初步核实、立案审查调查、案件审理办理（参考各模块梳理）
        4.问责信息录入模块，问责模块相关联动，嵌页面、后台逻辑处理
            涉及业务模块：谈话函询、初步核实、立案审查调查、案件审理办理
        5.单值代码梳理
        6.字段梳理，表结构调整
        7.单值代码映射共用方法
        8.字段映射共用方法
        9.嵌页面方式
        10.登记立案
        

    |功能点|开发人员|工作量(人/天)|
    |---|:---:|:---:|
    |9.嵌页面方式|孙文浩、林国庆|1
    |6.字段梳理，表结构调整|孙文浩|0.75
    |8.字段映射共用方法|孙文浩|0.75
    |2.结论模块|孙文浩|1
    |10.登记立案|孙文浩|1
    |3.附件模块(案件审理办理+线索排查会)|孙文浩|1.5
    |1.被反映人/被举报人模块|林国庆|1.25
    |3.附件模块(执纪监督+案管)|林国庆|1.5
    |4.问责信息录入模块|林国庆|0.75
    |5.单值代码梳理|林国庆|0.75
    |7.单值代码映射共用方法|林国庆|0.75


---

## 模块详细设计

- 库表设计
    增加表结构：新附件表、历次任职信息、家庭成员西信息
    表结构修改：参考下面字段梳理

- 字段映射共用方法

    使用场景：同样业务含义的两个对象中，两个不同名、但同含义的两个字段做映射处理。

    >业务系统列表展示单独做数据处理，zjjdApi直接存数，保障组件数据回写


    1. 差异字段梳理：
        
        <details><summary> 问题线索t_zhba_wtxs:</summary>

        |案管|执纪|字段含义|新增|备注|
        |---|---|---|:---:|---|
        |
        </details>

        <details><summary> 被举报人信息（问责对象信息）t_zhba_bjbr、t_zhba_thhx_bjbr、t_zhba_cbhs_bjbr：</summary>
        
        >问责对象信息，需要单独处理溢出的字段

        |案管|执纪|字段含义|新增|备注|
        |---|---|---|:---:|---|
        |c_bh_wtxs|c_ajbh|线索编号|
        |c_dxlx|c_sfdw|对象类型||单值代码要增加涉案人员
        |c_zjhm|c_sfzh|证件号码
        |c_dwwyjb|c_sfdwwy|党委委员级别|
        |c_zgddbjb|c_sfddb|中共党代表级别|
        |c_jwwyjb|c_sfjwwy|纪委委员级别|
        |c_sfybs|c_ybswj|是否一把手|
        |c_ybswj|c_wjqx|一把手违纪情形
        |dt_cjsj|d_cj_sj|创建时间|
        |dt_zhgxsj|d_zhgx_sj|修改时间
        |c_sfjcdx|c_sfxzjcdx|是否监察对象|
        |c_jcwwyjb||监委委员级别|是
        |c_dnzw||党内职务|是
        |c_qtzw||其他职务|是
        |c_lxfs||联系方式|是
        |lc_qtsm||其他说明|是
        |c_gjjcdxlx||国家监察对象类型|是|涉及单值代码修改
        |arr_jcdxlx||监察对象身份|是
        |arr_qtsf||其他身份|是
        |c_rddbjc||人大代表届次|是
        |c_zxwyjc||政协委员届次|是
        |c_dwlx||单位类型|是
        |c_sshy||所属行业|是
        |c_sarylx||涉案人员类型|是
        |c_sfjjjcgb||是否纪检监察干部|是
        </details>

        <details><summary> 立案审查t_zhba_lasc：</summary>

        |案管|执纪|字段含义|新增|备注|
        |---|---|---|:---:|---|
        |c_djbm|c_cbbm|承办部门|
        |c_djdw|c_cbdw|承办单位|
        |c_bljg|c_lajg|立案机关
        |d_djrq|d_slrq|受理日期
        |c_djr|c_slr|受理人
        |c_ajly|c_laajly|案件来源
        |dt_cjsj|d_cj_sj|创建时间
        |dt_zhgxsj|d_zhgx_sj|最后更新时间

        </details>

        <details><summary> 被调查人t_zhba_bdcr：</summary>
        
        同被调查人
        </details>

        <details><summary> 问题线索摘要t_zhba_xszy：</summary>

        |案管|执纪|字段含义|新增|备注|
        |---|---|---|:---:|---|
        |c_bh_bjbr|c_bjbrbh|被举报人编号
        |c_bh_wtxs|c_xsbh|问题线索编号
        |lc_wtxszy|c_wtxszy|问题线索摘要
        |c_nbyj||拟办意见|是
        </details>

        <details><summary> 违纪违法t_zhba_wjwf：</summary>
        

        |案管|执纪|字段含义|新增|备注|
        |---|---|---|:---:|---|
        |c_bh_xszy|c_xszybh|线索摘要编号
        |c_bh_bjbr|c_bjbrbh|被举报人编号
        |c_yjfl|c_wjyjfl|一级分类
        |arr_ejfl|c_wjejfl|二级分类||需要字段修改
        |dt_cjsj|d_cj_sj|创建时间
        |dt_zhgxsj|d_zhgx_sj|最后更新时间
        </details>

        <details><summary> 举报人t_zhba_jbr：</summary>

        |案管|执纪			|字段含义		|新增|备注|
        |---|---|---|---|---|
        |c_bh_wtxs|c_ajbh	|问题线索编号	||确认下该字段是否含义一致|
        |c_gzdw|c_dwmc		|工作单位		||字段名称有差异|
        |dt_cjsj|d_cj_sj	|创建时间		||字段名称不一致|
        |dt_zhgxsj|d_zhgx_sj|最后更新时间	||字段名称不一致|
        |c_jbrqk|lc_jbrqk	|举报人情况		||字段名称不一致一个是long，一个不是|
        |c_zzmm|		|政治面貌		|是|需要新增|
        |c_xzz|		|现住址			|是|需要新增|
        |c_zjlx|		|证件类型		|是|需要新增|
        </details>
    2. 公共映射方法

        功能方法：

        <details><summary>代码实现</summary>

        |参数名|参数含义|
        |---|---|
        |sourceObj|需转换对象
        |map|映射字段梳理
        |targetClazz|映射后的目标class
        |ifSave|true:保存，false：查询（数据回写）

        ```java
        /**
        * 字段映射共用方法
        *
        * @param sourceObj
        * @param map
        * @param targetClazz
        * @param <T>
        * @return
        */
        @ExceptionTips("保存字段映射转换异常")
        public <T> T convertColumn(Object sourceObj, Map<String, String> map, Class<T> targetClazz,boolean ifSave) {
            JSONObject jsonObject = JSON.parseObject(JSON.toJSONString(sourceObj));
            if (ifSave) {
                map.entrySet().forEach(m -> jsonObject.put(m.getValue(), jsonObject.getString(m.getKey())));
            } else {
                map.entrySet().forEach(m -> jsonObject.put(m.getKey(), jsonObject.getString(m.getValue())));
            }
            return jsonObject.toJavaObject(targetClazz);
        }
        ```
        </details>

        <details><summary>代码映射字段配置实现</summary>
        
        ```java
        package com.thunisoft.jcw.agxt.api.constant;

        import java.util.Collections;
        import java.util.HashMap;
        import java.util.Map;

        import lombok.experimental.UtilityClass;

        /**
        * @author sunwenhao
        * @date 2019/12/25 11:16
        */
        @UtilityClass
        public class WtxsdjConstant {
            private static final String COL_ZHGXSJ = "d_zhgx_sj";
            private static final String COL_CJSJ = "d_zhgx_sj";

            public static final Map<String, String> BJBR_MAP;

            static {
                HashMap<String, String> map = new HashMap<>();
                map.put("cWtxsbh", "c_ajbh");
                map.put("cDxlx", "c_sfdw");
                map.put("cZjhm", "c_sfzh");
                map.put("cDwwyjb", "c_sfdwwy");
                map.put("cZgddbjb", "c_sfddb");
                map.put("cJwwyjb", "c_sfjwwy");
                map.put("cSfybs", "c_ybswj");
                map.put("cYbswj", "c_wjqx");
                map.put("dtCjsj", COL_ZHGXSJ);
                map.put("dtZhgxsj", COL_ZHGXSJ);
                map.put("cSfjcdx", "c_sfxzjcdx");
                BJBR_MAP = Collections.unmodifiableMap(map);
            }

            public static final Map<String, String> XSZY_MAP;

            static {
                HashMap<String, String> map = new HashMap<>();
                map.put("c_bh_bjbr", "c_bjbrbh");
                map.put("c_bh_wtxs", "c_xsbh");
                map.put("lc_wtxszy", "c_wtxszy");
                XSZY_MAP = Collections.unmodifiableMap(map);
            }

            public static final Map<String, String> WJWF_MAP;

            static {
                HashMap<String, String> map = new HashMap<>();
                map.put("cBhXszy", "cXszybh");
                map.put("cBhBjbr", "cBjbrbh");
                map.put("cYjfl", "cWjyjfl");
                map.put("arrEjfl", "cWjejfl");
                map.put("dtCjsj", COL_CJSJ);
                map.put("dtZhgxsj", COL_ZHGXSJ);
                WJWF_MAP = Collections.unmodifiableMap(map);
            }

            public static final Map<String, String> LASC_MAP;

            static {
                HashMap<String, String> map = new HashMap<>();
                map.put("cDjbm", "c_cbbm");
                map.put("c_djdw", "c_cbdw");
                map.put("c_bljg", "c_lajg");
                map.put("d_djrq", "d_slrq");
                map.put("c_djr", "c_slr");
                map.put("c_ajly", "c_laajly");
                map.put("dt_cjsj", COL_CJSJ);
                map.put("dt_zhgxsj", COL_ZHGXSJ);
                LASC_MAP = Collections.unmodifiableMap(map);
            }
        }

        ```
        </details>


- 附件

    1. 表结构同组件表结构，原附件表结构保留

- 嵌页面方式+组件集成方式

    1. 嵌页面方式
    >部分模块涉及交互方式调整

        通过iframe链接方式，链接中参数根据controller拦截参数设置，尤其为tag，通过参数tag区分组件调用的dao层实现类。

    2. 组件集成方式

        - 实现dao层实现daoImpl，组件主动调用业务系统daoImpl
        - 通过@Component的value区分组件接口dao调用的实现类（daoImpl）,以被举报人为例：

            <details><summary>pom</summary>

            ```xml
            <dependency>
                <groupId>com.thunisoft.jcw</groupId>
                <artifactId>xsdj</artifactId>
                <version>0.0.1-SNAPSHOT</version>
            </dependency>
            ```
            </details>

            <details><summary>spring boot启动类配置</summary>

            ```java
            @ComponentScan({"com.thunisoft.jcw.xsdj"})
            @MapperScan({"com.thunisoft.jcw.xsdj.mapper"})
            public class ApiApplication {

                public static void main(String[] args) {
                    SpringApplication.run(ApiApplication.class, args);
                }

            }
            ```

            </details>

            <details><summary>daoImpl实现</summary>

            ```java
            package com.thunisoft.zhba.api.pzxt.dao.impl;

            import java.util.List;

            import org.springframework.beans.factory.annotation.Autowired;
            import org.springframework.stereotype.Component;

            import com.thunisoft.jcw.xsdj.dao.IBjbrDao;
            import com.thunisoft.jcw.xsdj.model.TBjbr;

            import lombok.RequiredArgsConstructor;

            /**
            * @author sunwenhao
            * @date 2019/12/27 17:57
            */
            @Component("thhxbjbr-bjbr")
            @RequiredArgsConstructor(onConstructor_ = @Autowired)
            public class ThhxbjbrDaoImpl implements IBjbrDao {

                @Override
                public int deleteBjbrByBjbrbh(String bjbrbh) {
                    return 0;
                }

                @Override
                public int insert(TBjbr object) {
                    return 0;
                }

                @Override
                public int updateWithoutCond(TBjbr object) {
                    return 0;
                }

                @Override
                public List<TBjbr> query(TBjbr object) {
                    return null;
                }
            }
            ```
            </details>


        - @Component的value值：

                1.value分为tag-bjbr、tag-fyr、tag-jtcy、tag-lcrz、tag-wjwf、tag-wtxs、tag-xszy
                2.业务系统tag区分方式：
                    谈话函询：thhx
                    初步核实：cbhs
                    立案审查：lasc
                    案件审理：ajsl
                        审理结论上传附件业务编号：              sljl
                        基本信息上传附件业务编号：              jbxx
                        问责基本信息上传附件业务编号：          wzjbxx
                        会议记录弹窗上传附件业务编号：          hyjl
                        结案登记上传附件业务编号：              jadj
                        退回补充审查调查上传附件业务编号：      thbcscdc
                        历史退回记录上传附件业务编号：          lsthjl
                        司法跟踪上传附件业务编号：              sfgz
                        审核把关反馈结果上传附件业务编号：      fkjg
                        申诉复查情况上传附件业务编号：          ssfc
                        商请检查机关提前介入上传附件业务编号：  sqjcjgtqjr
                        延长审理时限上传附件业务编号：          ycslsx
                        移送司法上传附件业务编号：              yssf
                3.附件tag区分：
                    共用：zjjd
                    登记立案：lasc
                由于全页面复用只涉及“登记立案模块”，故被调查人的tag用lasc，其他阶段bjbr模块级复用，用不同tag区分开
        
        - zjjd的dao层处理

            依据数据库表结构生成bean、mapper.java、mapper.xml、basemapper.xml，通过别名方式，与同名文件区分

- 单值代码梳理

    <details><summary>直接修改</summary>

    |单值代码含义|单值代码id|
    |---|---|
    |对象类型|45000216|
    |职级|45000358|
    |其他身份（新增）|45000863
    |中共党代表级别（新增）|45000860
    |党委委员级别（替换）|45000472
    |纪委委员级别（新增）|45000861
    |家庭成员关系（新增）|45000864
    |密级（新增）|45000865
    |问题线索来源二|45000859
    </details>

    <details><summary>需要做映射</summary>

    |单值代码含义|单值代码id|
    |---|---|
    </details>


- dao层设计

    由于zjjdApi中原bean字段不符合驼峰规范，为了保持和组件页面一致，减少修改工作量，故在com.thunisoft.zhba.api.pzxt路径下，构建字段符合驼峰格式的bean和mapper。
    
- 登记立案

        1.复用组件页面（全页面）
        2.优先保障流程，详情暂不考虑
- 被举报人/被反映人

        1.每个阶段bjbr对应一个daoImpl
        2.mapper要做对应修改（原因：业务系统流转需拷贝）
- 举报人/反映人

        
- 违纪违法模块

        1.多选字段业务系统需要做处理，如二级分类