# 派驻——线索排查会详细设计

author: 孙文浩

date: 2019.11.14.

---

## 目录
- [概述](#概述)
- [1排查会首页](#1排查会首页)
    - [1.1功能描述](#1.1功能描述)
    - [1.2数据库设计](#1.2数据库设计)
    - [1.3详情](#1.3详情)
- [2会议办理页面](#2会议办理页面)
    - [2.1功能描述](#2.1功能描述)
    - [2.2数据库设计](#2.2数据库设计)
    - [2.3详情](#2.3详情)
- [3业务流程场景控制](#3业务流程场景控制)
- [4开发计划](#4开发计划)
---
## 概述
V0.2版本针对V0.1版本流程简化
1. 原三次提交（审批）操作，简化为一次，省去上会线索提交操作，处置建议、会后材料提价操作合并
2. 页面从原来的六个页面简化为2个，首页列表页面、办理页面
3. 会议流程简化，原来多个会议状态简化为2个，进行中、已结束

---

## 1排查会首页

### 1.1功能描述

1. 添加会议
2. 进行中会议、已结束会议的列表展示，页面提供添加排查会入口。
3. 进行中，提供线索登记、变更会议、删除会议很审批详情操作入口。
4. 已结束，提供会议详情和审批详情入口。

### 1.2数据库设计
- t_xspch

    |字段名|字段含义|字段类型|字段长度|
    |---|---|---|---|
    |c_bh|排查会编号|VC|32
    |c_hymc|会议名称|VC|300
    |c_hydd|会议地点|VC|300
    |d_hysj|会议时间|TIMESTAMP|300
    |c_bz|备注|VC|300
    |c_chry|参会人员|VC|300
    |c_hyzt|会议状态|VC|300
    |c_cbr|承办人(经办人)|VC|300
    |c_cbbm|承办部门|VC|300
    |c_cbdw|承办单位|VC|300
    |c_czr|操作人|VC|300
    |dt_cjsj|创建时间|TIMESTAMP|300
    |dt_zhgxsj|最后更新时间|TIMESTAMP|300
    |c_bgyy|变更原因|VC|300
    |c_bglx|变更类型|VC|300

- t_pch_shxs

    |字段名|字段含义|字段类型|字段长度|
    |---|---|---|---|
    |c_bh|上会线索编号|VC|32
    |c_wtxs_bh|zjjd推送线索的编号|VC|32
    |c_xspch_bh|排查会编号|VC|32
    |c_cbbm|承办部门|VC|32


### 1.3详情
- 列表查询：
    
    1. 根据会议时间降序、按会议状态分组

            问题线索数统计维度：推送至pch库中的线索数

    2. 页面操作根据会议状态展示区分：
    
        |会议状态|状态值|所在页签|展示的操作入口
        |---|:---:|:---:|---|
        |进行中（未提审批）|hyzt=3|进行中|线索登记、变更会议、删除会议
        |审批中|hyzt=3,dqzt=0|进行中|审批详情
        |审批通过|hyzt=3,dqzt=1|进行中|线索登记、审批详情
        |审批退回|hyzt=3,dqzt=2|进行中|线索登记、审批详情
        |已结束|hyzt=6|已结束|会议详情、审批详情

>审批提交后，需要对c_hyzt字段进行更新，更新动作在zjjdApi中完成

>会议状态：进行中3、审批中（dqzt=1）、审批通过（dqzt=2）、审批退回（dqzt=3）、已结束6（审批通过）

>0：未读，1：审批中，2：审批结束，3：退回，4：撤回，5：退回后重新发起又撤回

- 发起、变更会议弹框

    通过同一个模态框实现，复用pchsy.html的模态框，模态框控件控制，根据页面操作入口传参控制

- 页面详情入口

    对接详情服务
    1. 会议详情
    2. 审批详情
    

---

## 2会议办理页面

### 2.1功能描述

1. 添加上会线索
2. 录入处置建议
3. 删除添加的上会线索
4. 详情查看
5. 导出处置建议分类表
6. 附件上传、预览、下载、删除
7. 文书生成、编辑、删除
8. 审批（涵盖审批开关）

### 2.2数据库设计

### 2.3详情
>接口相关内容，处置相关需求开发后调整
- 待添加上会线索查询：

1. 可复用原页面模块，去除是否上会的条件过滤。
2. 查数接口数据查询范围：未上会线索、待处置中重新开始的暂存待查线索
    - 从执纪监督查询待上会线索给pch：   

        GET:   http://ip:port/api/getPchDshxs

        请求体：

        

        响应体：


    - 标记执纪监督的线索被添加pch：     

        PATCH:  http://ip:port/api/tagOnShxs

        请求体：

        ```json
        [
            "407e183450264f40bbbf6500a1cff942",
            "54523b60cf8c4d8499d415438e2dbd30"
        ]

        ```
        响应体：
        ```json
        {
            "success":"true",
            "message":"ok"
        }
        ```


- 批量添加上会线索（兼容单个添加）：
    

    - 推送已添加上会的线索至排查会接口：

        POST:   http://ip:port/api/addPchShxs{pchbh}


        请求体：
        ```json
        [{
            "cBh":"2cebf390a0ec4fa1be84def2a5d3e559",
            "":""
        },
        {},{}
        ] 
        ```


        响应体：
        ```json
        {
            "success":"true",
            "message":"ok"
        }
        ```
- 删除已添加的上会线索
    
        DELETE:http://ip:port/api/delShxs/{wtxsbh}

    |请求参数|参数含义|
    |---|---|
    |wtxsbh|问题线索编号
    

- 线索变更会议接口

        PATCH:http://ip:port/api/changeShxsToNewPch/{pchbh}
    
    |请求参数|参数含义|
    |---|---|
    |pchbh|排查会编号

- 录入处置意见

    1. 继续办理线索在具体办理阶段中选择上会，不开放录入处置意见操作入口，根据t_pch_shxs.c_sfsh字段控制。
    2. 录入处置意见模态框，页面控制，js以及后台功能方法逻辑可复用或优化

    - 承办人、审理人下拉列表获取人员调用的接口（agxtApi接口需要调整）：
    
        GET:    http://ip:port/api/v1/nbfz/{type}/{userId/ssbm}

        type=1，传userid，获取部门下所有人员

        ```json

        {
                "success": "true/false",
                "message": "ok/missing type"
                "data": {
                        "689754742": "安徽省案件监督承办人01",
                        "689764073": "安徽省案件监督承办人02",
                        "689770012": "安徽省案件监督承办人03",
                        "1119307109": "安徽案管室主任",
                        "1205183595": "安徽案管线索管理员1",
                        "1205197887": "安徽案管线索管理员2"
                        }
        }
        ```
        type=2，传ssbm，获取所有内部分组信息

        ```json

        {
                "success": "true/false",
                "message": "ok/missing type",
                "data": {
                        "内部分组编号":"内部分组名称",
                        "273db09a1f8aeb358cb905f15152e2cb": "bvadf",
                        "0b496cd7d9a5cccc66368a2ef80e1542": "gfea"
                        }
        }

        ```

        type=3，传userid，获取人员所在分组的所有成员

        ```json

        {
                "success": "true/false",
                "message": "ok/missing type",
                "data": {
                        "34000009002": "王在胜",
                        "34000009001": "郝家福"
                        }
        }

        ```

        type=4，传随机数，传所有内部分组组长

        ```json

        {
                "success": "true/false",
                "message": "ok/missing type",
                "data": {
                        "529a1fea9f3f4881acd8b97e25f3c3b9": "34000009002",
                        "内部分组编号":"组长id"
                        }
        }

        ```



        代码实现：


        ```java
            @GetMapping("{type}/{id}")
            public JSONObject getNbfzxx(@PathVariable String type, @PathVariable String id) {
                JSONObject jsonObject = new JSONObject();
                jsonObject.put("success", "true");
                jsonObject.put("message", "ok");
                try {
                    switch (type) {
                        case ALL_USER:
                            String deptId = OrganUtil.getUser(id).getDeptId();
                            StringBuilder stringBuilder = new StringBuilder();
                            stringBuilder.append(ConfigUtil.getProperty("taap.base.uimApi.url")).append("/api/depts/" + deptId + "/users");
                            ResponseEntity<JSONObject> responseEntity = restTemplate.getForEntity(stringBuilder.toString(), JSONObject.class);
                            JSONObject userJsonObject = new JSONObject();
                            JSONArray jsonArray = responseEntity.getBody().getJSONArray("data");
                            for (int i = 0; i < jsonArray.size(); i++) {
                                userJsonObject.put(jsonArray.getJSONObject(i).getString("id"), jsonArray.getJSONObject(i).getString("showName"));
                            }
                            jsonObject.put("data", userJsonObject);
                            return jsonObject;
                        case ALL_NBFZ:
                            jsonObject.put("data", nbfzService.queryAllNbfz());
                            return jsonObject;
                        case ALL_NBFZRY:
                            jsonObject.put("data", nbfzService.queryAllUserInNbfz(id));
                            return jsonObject;
                        case ALL_NBFZXX:
                            jsonObject.put("data", nbfzService.queryNbfzxx(id));
                            return jsonObject;
                        default:
                            jsonObject.put("success", "false");
                            jsonObject.put("message", "missing type");
                            log.info("传参有误：missing type");
                    }
                } catch (Exception e) {
                    jsonObject.put("success", "false");
                    jsonObject.put("message", "missing type");
                    log.error("获取内部分组相关信息出错", e);
                    return jsonObject;
                }
                return jsonObject;
            }
        ```

    - 承办人、审理人下拉类别获取人员在办案件数的接口 ：

        POST http://ip:port/api/cbr/countzbjs

        请求体：
        ```json
        {
                        "689754742": "安徽省案件监督承办人01",
                        "689764073": "安徽省案件监督承办人02",
                        "689770012": "安徽省案件监督承办人03",
                        "1119307109": "安徽案管室主任",
                        "1205183595": "安徽案管线索管理员1",
                        "1205197887": "安徽案管线索管理员2",
                        "34000009004": "夏延生",
                        "34000009005": "杜忠法",
                        "34000009002": "王在胜",
                        "34000009003": "楼伟成"
            }
        }
        ```


        响应体：

        ```json
        {
            "success": "true",
            "message": "ok",
            "data":{
                "1223234234":"120",
                "1257676766":"100"
            }
        }
        ```
        代码实现

        ```java

            @PostMapping("/countzbjs")
            public JSONObject getZbsl(@RequestBody JSONObject jsonObject) {
                JSONObject jb = new JSONObject();
                try {
                    List<String> ryidList = new ArrayList<>();
                    jsonObject.keySet().forEach(e -> ryidList.add(e));
                    jb.put("success", "true");
                    jb.put("message", "ok");
                    jb.put("data", cbrzbService.getZbsl(ryidList));
                } catch (Exception e) {
                    jb.put("success", "false");
                    jb.put("message", "missing type");
                    log.error("获取承办人相关信息出错", e);
                    return jb;
                }
                return jb;
            }

            @Override
            public JSONObject getZbsl(List<String> ryidList) {
                JSONObject jsonObject = new JSONObject();
                List<Map<String, String>> listMap = tZhbaWtxsMapper.selectZbsl(ryidList);
                listMap.forEach(e -> jsonObject.put(e.get("c_cbr"), e.get("c_ajs")));
                return jsonObject;
            }
                



        ```
- 生成处置建议分类表

    保存时hyjd存0，通过hyjd=0排序，将处置建议分类表排在页面列表第一位

- 文书、审批相关

    1. 文书模板增加提交审批入口
    2. 文书模板增加提交审批按钮
    3. 文书模板增加需要审批状态字段
    
    - 调用审批页面
    
            url:http://ip:port/spfw/spgzqsq.html/?businessKey=&dataId=&spType=&attachmentUrl=&detailUrl=&sysId=
    - 开放文书附件查询接口给审批调用
        
            GET:http://ip:port/pz-xspch/queryWsYFj/{ywbh}/{cbr}

- 附件上传
    
    - 复用文件上传模块，保存逻辑调整
        
        保存时绑定附件到人和内部分组

    - 附件的数据查询
    1. 有数据权限，根据数据权限查
    2. 没有数据权限根据人查，根据数据库字段c_czr过滤
    3. 如果是组长再根据内部分组编号查询 

    - 对于列表排序问题
    1. 生成处置建议分类表，每次生成hyjd=0
    2. 上传的附件，hyjd=1

- 审批通过后操作（zjjdApi操作）
    
    1. 流程操作

        对应zjjdApi中代码片段（JsspCallBack.java）：

        ```java
        case PCHHYJY:
            restTemplate.getForEntity(systemConfig.getXspch().getUrl() + "/api/xspch/wtxsczfs/" + dataId, String.class);
            break;
        case PCHHCZYJFLB:
            //排查会后处置意见变更
            String[] data = dataId.split(";");
            String pchId = data[0];
            String cbbm = data[1];
            xspchService.sendPchData(pchId, cbbm);
            break;
        ```

        - 推送zjjd字段：
        
            |字段名|字段含义|
            |---|---|
            |t_zhba_wtxs.c_sfsh|是否上会（置为2）
            |t_zhba_wtxs.c_pchhczfs|排查会处置方式
            |t_zhba_wtxs.c_pchzt|排查会状态（置为3）
            |t_zhba_xsfl.c_xsflczfs|线索分流处置方式
            |t_zhba_xsfl.c_czjy|处置建议
            |t_zhba_xsfl.c_xsfljsbm|线索分流接收部门
        - pch内部更新字段：
            |字段名|字段含义|
            |---|---|
            |t_pch_shxs.c_spzt|审批状态
    2. 排查会内部状态控制
        

            t_spgl.c_dqzt=0：审批中
            页面控制变量校验库中该字段，禁止页面操作

            t_spgl.c_dqzt=1：审批通过
            页面控制变量校验库中该字段，禁止页面操作

            t_spgl.c_dqzt=2：审批退回
            页面控制变量校验库中该字段，开放页面操作
            
        页面通过sftjsp参数控制

            hyzt=3,dqzt=0 or dqzt=2时：sftjsp=false
            其他情况：sftjsp=false

---

## 3业务流程场景控制

- 已上会线索不存在再次上会

- 添加排查会接口查询数据范围

    1. 未上会线索
    2. 处置建议阶段暂存待查数据

- 页面操作功能权限
    1.细化权限点（待梳理），根据权限点控制相关功能模块

---

## 4开发计划
|模块|功能点|工作量（单位：人/天）|
|---|---|:---:|
|排查会首页|首页列表修改，查询+操作控制|1
|排查会首页|首页添加、变更会议+部分样式|1
|办理页面|添加上会线索，查询接口+推数接口+保存+添加列表页面|2
|办理页面|已添加上会线索列表查询+录入处置建议+删除接口|2
|办理页面|生成处置建议分类表+附件上传+附件列表数据权限|2
|办理页面|文书模板修改+文书对接+审批对接|3.5
|流程相关|处置建议提交+会后材料提交接口整合|1.5
|权限|数据权限+功能权限|2